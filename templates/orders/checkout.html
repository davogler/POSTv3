{% extends "base.html" %}

{% block title %}{{ flatpage.title }} | {{ block.super }}{% endblock %}

{% block bodyclass %}{{ block.super }}flatpage {{ flatpage.title|slugify }}{% endblock %}




{% block headernav %}
{% load article_tags %}
{% banner request %} 
{% endblock %}

{% block content %}
{{ block.super }}
 <!-- The required Stripe lib -->
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
 
  <!-- jQuery is used only for this example; it isn't required to use Stripe -->
  <!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
  

 
  

<section class="content-static">
  <div class="brick clearfix">
  

    <div class="wrapper content">
        
      
        <h2>My Order</h2>
         <div class="table-responsive">
        <div class="tertal">
                <p><span class="tit">Sub Total: </span>${{ cart.product_total|floatformat:2 }}<br>
                <span class="tit">Shipping:</span> ${{ cart.shipping_total|floatformat:2 }}</p>
                <hr>
                <p><span class="tit">Grand Total:</span> ${{ cart.total|floatformat:2 }}</p>
                

            </div>


  <table class="table ordershow">
                 <thead>
                  <tr>
                    <th class="item">Item</th>
                    <th class="recip">Recipient</th>
                
                  </tr>

                </thead>
                <tbody>

                
                
                  {% for item in subbies %}
                  <tr class="subbie">
                    <td class="item">{{ item.subscription.title }}</td>
                   
                    <td class="recip">
                    <span class="sendto">send to:</span><br>
                    {% if item.recipient %}
                        {% with item.recipient as item %}
                         {% include "customers/address_display.html" %}
                        {% endwith %}
                        
                        
                            <a href="{% url "add_recipient" %}?itm={{item.id}}&next=checkout" class="btn btn-primary pcta">Change Address</a>
                        {% else %}
                            <a href="{% url "add_recipient" %}?itm={{item.id}}&next=checkout" class="btn btn-primary pcta">Add Address</a>
                    {% endif %}
                    </td>
                    
                  </tr>
                  {% endfor %}


                  {% for item in singles|slice:":1" %}
                    
                  <tr>
                    <td class="item">{{ item.single.month }} issue ({{item.quantity}})</td>
                    <td rowspan="{{ singles|length }}" class="recip">
                        {% if forloop.first %}
                        <span class="sendto">send to:</span><br>
                            {% if order.main_recipient %}
                                    
                                    {% with order.main_recipient as item %}
                                        {% include "customers/address_display.html" %}
                                    {% endwith %}
                                    
                                    <a href="{% url "add_recipient" %}?rec={{order.id}}&next=checkout" class="btn btn-primary pcta">Change Address</a>
                            {% else %}
                                    <a href="{% url "add_recipient" %}?rec={{order.id}}&next=checkout" class="btn btn-primary pcta">Add Address</a>
                            {% endif %}
                        {% endif %}
                    </td>
                   
                  </tr>
                  {% endfor %}

                  {% for item in singles|slice:"1:" %}
                    
                  <tr>
                    <td class="item">{{ item.single.month }} issue ({{item.quantity}})</td>
                    
                   
                  </tr>
                  {% endfor %}
               


               </tbody>
                
          </table>
          </div>

<div id ="usergo">
    <h2>Account Details</h2>
    {% if user.is_authenticated %}
        <p>You're logged in as {{ user }}</p>

    {% else %}
    <p>You're a guest. Login or Register</p>

    {% endif %}
</div>
   
         
<div id="paystub" >

        <h2>Payment Details</h2>

 <section class="messages">
    {% if messages %}
        {% for message in messages %}
            <div class='alert {% if "success" in message.tags %}alert-success{% elif "warning" in message.tags%}alert-warning{% elif "error" in message.tags %}alert-danger{% endif %} alert-dismissible' role='alert'>
            <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only"></span></button>
            {% if "safe" in message.tags %}{{ message|safe }}{% else %}{{ message }}{% endif %}</div>
        {% endfor %}
    {% endif %}
    </section>

    <div class="thirdsies-right">

    <div class='col-sm-8 col-sm-offset-2 orderbox clearfix' >
      <h2>Order Details</h2>
      <ul>
      {% for item in order.items_as_list %}
           <li>{{ item|safe }}</li>
      {% endfor %}
      </ul>
          <p class="dim">ID: {{ order.order_id }}</p>
          <p>Total: ${{ order.total|floatformat:2 }}</p>
      
  </div>

  <div class="trustbox">
    <ul class="accepted">
      <li><img class="cc-icon" src="/assets/i/visa.png"></li>
      <li><img class="cc-icon" src="/assets/i/mastercard.png"></li>
      <li><img class="cc-icon" src="/assets/i/discover.png"></li>
    </ul>
    <ul class="accepted">
      <li><img class="cc-icon" src="/assets/i/american_express.png"></li>
      <li><img class="cc-icon" src="/assets/i/jcb.png"></li>
      <li><img class="cc-icon" src="/assets/i/diners_club.png"></li>
    </ul>
    <img class="secure" src="/assets/i/comodo.png">
  </div>

</div>

<div class="halfsies-left">
 
  <form autocomplete="on" action="" method="POST" id="payment-form" >{% csrf_token %}
  <h2>User</h2>

   <div id="div_id_name" class="form-group">
      <label for="id_password" class="control-label ">Passwerd </label>
      <div class="controls ">
        <input type="text" class="textinput textInput form-control" size="20" value="{{ order.customer.name }}" name="name"/> 
      </div>
    </div>

     <div id="div_id_name" class="form-group">
      <label for="id_password2" class="control-label ">Paaswerd2 </label>
      <div class="controls ">
        <input type="text" class="textinput textInput form-control" size="20" value="{{ order.customer.name }}" name="name"/> 
      </div>
    </div>

    <h2>Payment</h2>
    {{ pay_form }}

    <div class="erro">
      <span class="payment-errors"></span>
    </div>


    <div id="div_id_name" class="form-group">
      <label for="id_name" class="control-label ">Name </label>
      <div class="controls ">
        <input type="text" class="textinput textInput form-control" size="20" value="{{ order.customer.name }}" name="name"/> 
      </div>
    </div>

    <div id="div_id_email" class="form-group">
      <label for="id_email" class="control-label ">Email </label>
      <div class="controls ">
        <input type="text" class="textinput textInput form-control" size="20" value="{{ order.customer.email }}" name="email" />
      </div>
    </div>

    <div class="form-group clearfix">

      <div id="div_id_card" >
        <label for="id_card" class="control-label">Card Number </label>
        <div class="controls ">
          <input type="tel" class="textinput textInput form-control cc-number" autocomplete="cc-exp" size="20" data-stripe="number" placeholder="•••• •••• •••• ••••" required>
        </div>
      </div>

      <div id="cvc" >
        <label>CVC</label>
        <input type="tel" class="form-control cc-cvc" size="4" data-stripe="cvc" autocomplete="off" placeholder="•••" required>
      </div>

    </div>

    

    <div class="form-group clearfix">

          
      <div id="card_month" class="form-group">
        <label>Exp Month</label>
        <input type="tel" class="form-control" size="2" data-stripe="exp-month" placeholder="MM">
      </div>

    
      <div id ="card_year" class="form-group">
        <label>Exp Year</label>
        <input type="tel" class="form-control" size="4" data-stripe="exp-year" placeholder="YYYY">
      </div>
                
    </div>

    
    <button type="submit" class="btn btn-primary pcta">
        <span class="glyphicon glyphicon-lock" aria-hidden="true"></span>
        Submit Payment
    </button>
    <a class="btn btn-default" href="{% url 'cart_empty' %}" role="button">Cancel</a>


  </form>
    </div>
  
  </div>

</section>

</div>

{% endblock %}

{% block inlinejs %}

<script src="{{ STATIC_URL }}js/vendor/jquery.payment.js"></script>

<script type="text/javascript">
    // This identifies your website in the createToken call below
    Stripe.setPublishableKey('pk_CsG24ZSjBprYMnDHbs1AABi2sxQy7');

    var stripeResponseHandler = function(status, response) {
      var $form = $('#payment-form');

      if (response.error) {
        // Show the errors on the form
        $form.find('.payment-errors').text(response.error.message);
        $form.find('button').prop('disabled', false);
      } else {
        // token contains id, last4, and card type
        var token = response.id;
        var last4 = response.card.last4;
        var card_type = response.card.brand
        // Insert the token into the form so it gets submitted to the server
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        $form.append($('<input type="hidden" name="last4" />').val(last4));
        $form.append($('<input type="hidden" name="card_type" />').val(card_type));
        // and re-submit
        $form.get(0).submit();
      }
    };

    jQuery(function($) {
      $('#payment-form').submit(function(e) {
        var $form = $(this);

        // Disable the submit button to prevent repeated clicks
        $form.find('button').prop('disabled', true);

        Stripe.card.createToken($form, stripeResponseHandler);

        // Prevent the form from submitting with the default action
        return false;
      });
    });

    jQuery(function($) {
      
      $('.cc-number').payment('formatCardNumber');
      $('.cc-exp').payment('formatCardExpiry');
      $('.cc-cvc').payment('formatCardCVC');
      
                       
      
      
    });
  </script>

{% endblock %}



